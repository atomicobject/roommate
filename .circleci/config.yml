version: 2.1
jobs:
  build:
    docker:
      - image: jrrr/esp32-ci:36f58149da1f0bd0385194a461a332ebdfb43549
      # Espressif has a docker image! espressif/esp32-ci-env
      # but it's out of date:
      # WARNING: Toolchain version is not supported: 1.22.0-61-gab8375a
      # Expected to see version: 1.22.0-80-g6c4433a
    steps:
      - checkout
      - run: git submodule sync
      - run: git submodule update --init
      - run: xtensa-esp32-elf-gcc --version

      # - run:
      #     name: Build
      #     command: cd make; make all

      - run:
          name: cmake
          command: cmake -S . -B build -DCMAKE_TOOLCHAIN_FILE=amazon-freertos/tools/cmake/toolchains/xtensa-esp32.cmake -G Ninja

      - run:
          name: ninja
          command: cd build ; ninja my_app

      - run:
          name: Test
          command: cd test; make
